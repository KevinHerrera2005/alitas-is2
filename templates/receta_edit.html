<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Receta | Alitas El ComelÃ³n</title>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f7f7f7;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 30px;
      min-height: 100vh;
    }
    h1 {
      color: #b80000;
      margin-bottom: 15px;
    }
    form {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      width: 380px;
    }
    label {
      font-weight: 600;
      color: #333;
      display: block;
      margin-top: 10px;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-top: 5px;
      box-sizing: border-box;
    }
    .msg {
      font-size: 0.85em;
      text-align: left;
      margin-top: 3px;
      margin-bottom: 5px;
    }
    .ok { color: green; }
    .error { color: red; }
    .inline-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 15px;
    }
    button {
      width: 100%;
      background-color: #e60000;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      margin-top: 15px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    button:hover { background-color: #b80000; }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .btn-secundario {
      background-color: #007bff;
    }
    .btn-secundario:hover {
      background-color: #0056b3;
    }
    #listaInsumos {
      margin-top: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      background: #f9f9f9;
      display: none;
    }
    #listaInsumos p {
      margin: 0 0 4px 0;
    }
    a.enlace-volver {
      text-decoration: none;
      color: #b80000;
      font-weight: bold;
      display: block;
      text-align: center;
      margin-top: 15px;
    }
    .btn-mini {
      background-color: #28a745;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
      font-size: 0.85em;
      transition: 0.3s;
      display: inline-block;
      margin-left: 8px;
    }
    .btn-mini:hover {
      background-color: #1f7e34;
    }
  </style>

  <script src="{{ url_for('static', filename='js/validaciones.js') }}"></script>
</head>
<body>

<h1>Editar Receta</h1>

<script>
window.addEventListener('submit', (e) => {
  const data = document.getElementById('insumos_json').value;
  console.log('ðŸ“¦ INSUMOS ENVIADOS AL GUARDAR:', data);
});
</script>

<form id="formReceta"
      action="{{ url_for('editar_receta', id_receta=receta.ID_Receta) }}"
      method="POST">

  <label>Nombre de la Receta:</label>
  <input type="text"
         id="nombre"
         name="nombre"
         required
         value="{{ receta.Nombre_receta }}">
  <div id="msgNombre" class="msg"></div>

  <label>Pasos a seguir:</label>
  <textarea id="descripcion"
            name="descripcion"
            rows="3"
            required>{{ receta.descripcion }}</textarea>
  <div id="msgDescripcion" class="msg"></div>

  <label>DescripciÃ³n que verÃ¡ el cliente:</label>
  <textarea id="descripcion_cliente"
            name="descripcion_cliente"
            rows="3">{{ receta.descripcion_cliente or '' }}</textarea>
  <div id="msgDescripcionCliente" class="msg"></div>

  <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 5px;">
    <label style="margin: 0;">CategorÃ­a de la Receta:</label>
    <a href="/admin/categoria_recetas_admin/" class="btn-mini">
      âž• Agregar
    </a>
  </div>

  <select id="categoria_receta" name="categoria" required style="width: 100%; margin-top: 5px;">

    <option value="">-- Selecciona una categorÃ­a --</option>
    {% for id_cat, nombre_cat in categorias.items() %}
      <option value="{{ id_cat }}"
              {% if id_cat == receta.categoria %}selected{% endif %}>
        {{ nombre_cat }}
      </option>
    {% endfor %}
  </select>

  <label style="margin-top: 15px;">Insumos actuales de la receta:</label>
  <select id="insumo_receta" onchange="cargarInsumoDesdeReceta()">
    <option value="">-- Selecciona un insumo de la receta --</option>
  </select>

  <label style="margin-top: 15px;">Seleccionar Insumo:</label>

  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
    <span></span>
    <a href="/admin/insumo/" class="btn-mini">âž• Agregar</a>
  </div>

  <select id="insumo">
    <option value="">-- Selecciona un insumo --</option>
    {% for insumo in insumos %}
      <option value="{{ insumo.ID_Insumo }}" data-tipo="{{ insumo.Tipo }}">
        {{ insumo.Nombre_insumo }}
      </option>
    {% endfor %}
  </select>

  <select id="unidad" style="margin-top: 5px;">
    <option value="">-- Selecciona unidad --</option>
    {% for unidad in unidades %}
      <option value="{{ unidad.ID_Unidad }}" data-tipo="{{ unidad.Tipo }}">
        {{ unidad.Nombre_Unidad }}
      </option>
    {% endfor %}
  </select>

  <label style="margin-top: 15px;">Cantidad usada:</label>
  <input type="number" id="cantidad" step="0.01" min="0.01">

  <div class="inline-buttons">
    <button type="button" onclick="agregarInsumo()">âž• Guardar insumo</button>
    <button type="button" class="btn-secundario" onclick="toggleLista()">ðŸ‘€ Ver insumos</button>
  </div>

  <div id="listaInsumos"></div>
  <input type="hidden" name="insumos_json" id="insumos_json">

  <button id="guardarBtn" type="submit">Guardar cambios</button>
  <a href="{{ url_for('crud_recetas') }}" class="enlace-volver">â¬… Volver al panel</a>
</form>

<script>
  const insumosIniciales = {{ ingredientes | tojson | safe }};
  let insumosSeleccionados = [...insumosIniciales];
  let indiceEditando = null;

  function actualizarHiddenJSON() {
    const hidden = document.getElementById('insumos_json');
    hidden.value = JSON.stringify(insumosSeleccionados);
  }

  function renderLista() {
    const lista = document.getElementById('listaInsumos');
    lista.innerHTML = "";

    if (insumosSeleccionados.length === 0) {
      lista.style.display = "none";
      actualizarHiddenJSON();
      return;
    }

    insumosSeleccionados.forEach((item, i) => {
      const linea = document.createElement('p');
      linea.textContent = `${i + 1}. ${item.nombre_insumo} - ${item.cantidad} ${item.nombre_unidad}`;
      lista.appendChild(linea);
    });

    lista.style.display = "block";
    actualizarHiddenJSON();
  }

  function renderSelectInsumosReceta() {
    const select = document.getElementById('insumo_receta');
    const valorActual = select.value;

    select.innerHTML = "";
    const optBase = document.createElement('option');
    optBase.value = "";
    optBase.textContent = "-- Selecciona un insumo de la receta --";
    select.appendChild(optBase);

    insumosSeleccionados.forEach((item, i) => {
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.dataset.idInsumo = item.id_insumo;
      opt.dataset.idUnidad = item.id_unidad;
      opt.dataset.cantidad = item.cantidad;
      opt.dataset.tipo = item.tipo || "";
      opt.textContent = `${item.nombre_insumo} - ${item.cantidad} ${item.nombre_unidad}`;
      select.appendChild(opt);
    });

    if (valorActual && Number(valorActual) < insumosSeleccionados.length) {
      select.value = valorActual;
    }
  }

  function limpiarCamposInsumo() {
    document.getElementById('insumo').value = "";
    document.getElementById('unidad').value = "";
    document.getElementById('cantidad').value = "";
  }

  function cargarInsumoDesdeReceta() {
    const select = document.getElementById('insumo_receta');
    const idxStr = select.value;

    if (!idxStr) {
      indiceEditando = null;
      limpiarCamposInsumo();
      return;
    }

    const idx = parseInt(idxStr, 10);
    if (isNaN(idx) || idx < 0 || idx >= insumosSeleccionados.length) {
      indiceEditando = null;
      limpiarCamposInsumo();
      return;
    }

    indiceEditando = idx;
    const ing = insumosSeleccionados[idx];

    document.getElementById('insumo').value   = String(ing.id_insumo);
    document.getElementById('unidad').value   = String(ing.id_unidad);
    document.getElementById('cantidad').value = ing.cantidad;
  }

  function toggleLista() {
    const lista = document.getElementById('listaInsumos');
    if (lista.style.display === "none" || lista.style.display === "") {
      if (insumosSeleccionados.length > 0) {
        lista.style.display = "block";
      }
    } else {
      lista.style.display = "none";
    }
  }

  function agregarInsumo() {
    const insumoSel  = document.getElementById('insumo');
    const cantidadEl = document.getElementById('cantidad');
    const unidadSel  = document.getElementById('unidad');

    if (!insumoSel.value || !cantidadEl.value || !unidadSel.value) {
      alert('Por favor, completa todos los campos del insumo.');
      return;
    }

    const tipoInsumo = insumoSel.options[insumoSel.selectedIndex]?.getAttribute('data-tipo');
    const tipoUnidad = unidadSel.options[unidadSel.selectedIndex]?.getAttribute('data-tipo');

    if (tipoInsumo && tipoUnidad && tipoInsumo !== tipoUnidad) {
      alert('âš  No puedes asignar medidas errÃ³neas.\nEjemplo: no puedes usar litros para algo sÃ³lido.');
      return;
    }

    const idExistente = (indiceEditando !== null && !isNaN(indiceEditando))
      ? (insumosSeleccionados[indiceEditando]?.id_in_re ?? null)
      : null;

    const nuevoInsumo = {
      id_in_re: idExistente,
      id_insumo: insumoSel.value,
      nombre_insumo: insumoSel.options[insumoSel.selectedIndex].text,
      cantidad: parseFloat(cantidadEl.value),
      id_unidad: unidadSel.value,
      nombre_unidad: unidadSel.options[unidadSel.selectedIndex].text,
      tipo: tipoInsumo || ""
    };

    if (indiceEditando !== null && !isNaN(indiceEditando)) {
      insumosSeleccionados[indiceEditando] = nuevoInsumo;
    } else {
      insumosSeleccionados.push(nuevoInsumo);
    }

    indiceEditando = null;
    document.getElementById('insumo_receta').value = "";

    renderLista();
    renderSelectInsumosReceta();
    limpiarCamposInsumo();
  }

  renderLista();
  renderSelectInsumosReceta();
</script>
<script>
function actualizarUnidadesPorInsumo(selectInsumo) {
    const idInsumo = parseInt(selectInsumo.value || "0", 10);
    const contenedor = selectInsumo.closest(".fila-insumo") || document;
    const selectUnidad = contenedor.querySelector(".select-unidad");
    const msg = contenedor.querySelector(".msg-tipo") || null;

    if (!selectUnidad) return;

    if (!idInsumo) {
        selectUnidad.innerHTML = "";
        if (msg) msg.textContent = "";
        return;
    }

    fetch("{{ url_for('receta_tipo_lookup') }}?id_insumo=" + encodeURIComponent(idInsumo))
        .then(async (res) => {
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || "Error al consultar tipos");
            return data;
        })
        .then((data) => {
            const unidades = Array.isArray(data.unidades) ? data.unidades : [];
            selectUnidad.innerHTML = "";

            for (const u of unidades) {
                const opt = document.createElement("option");
                opt.value = u.id;
                opt.textContent = u.nombre;
                selectUnidad.appendChild(opt);
            }

            if (msg) msg.textContent = "";
        })
        .catch((err) => {
            selectUnidad.innerHTML = "";
            if (msg) msg.textContent = "No se pudo validar: " + (err.message || "Error al consultar tipos");
        });
}

document.addEventListener("change", function(e) {
    if (e.target && e.target.classList.contains("select-insumo")) {
        actualizarUnidadesPorInsumo(e.target);
    }
});
</script>
<script>
(function () {
  const insumoSel = document.getElementById("insumo");
  const unidadSel = document.getElementById("unidad");
  if (!insumoSel || !unidadSel) return;

  const placeholder = unidadSel.querySelector('option[value=""]');
  const opcionesOriginales = Array.from(unidadSel.querySelectorAll("option")).filter(o => o.value !== "");

  function filtrarUnidades() {
    const optInsumo = insumoSel.options[insumoSel.selectedIndex];
    const tipoInsumo = optInsumo ? (optInsumo.getAttribute("data-tipo") || "") : "";

    unidadSel.innerHTML = "";
    if (placeholder) unidadSel.appendChild(placeholder.cloneNode(true));

    if (!insumoSel.value || !tipoInsumo) {
      for (const opt of opcionesOriginales) unidadSel.appendChild(opt.cloneNode(true));
      return;
    }

    const compatibles = opcionesOriginales.filter(o => (o.getAttribute("data-tipo") || "") === tipoInsumo);

    for (const opt of compatibles) unidadSel.appendChild(opt.cloneNode(true));

    if (unidadSel.options.length <= 1) {
      unidadSel.value = "";
    }
  }

  insumoSel.addEventListener("change", filtrarUnidades);
  filtrarUnidades();
})();
</script>
<script>
(function () {
  const cat = document.getElementById("categoria_receta");
  if (!cat) return;

  cat.addEventListener("change", function (e) {
    e.stopImmediatePropagation();
  }, true);
})();
</script>

</body>
</html>
