<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Confirmar compra</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f5f5f5;
        }
        .checkout-wrapper {
            padding-top: 30px;
            padding-bottom: 30px;
        }
        .checkout-title {
            font-weight: 700;
            margin-bottom: 20px;
        }
        .summary-total {
            font-size: 1.2rem;
            font-weight: 700;
        }
        .summary-items {
            max-height: 280px;
            overflow-y: auto;
        }
        .summary-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 6px 0;
            font-size: 0.95rem;
        }
        .summary-item-name {
            font-weight: 500;
        }
        .summary-item-qty {
            color: #666;
            font-size: 0.9rem;
        }
        .summary-item-subtotal {
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="container checkout-wrapper">
    <h2 class="checkout-title">Confirmar compra</h2>

    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        <div class="mt-2">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'danger' else category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form action="{{ url_for('generar_factura') }}" method="get" id="formCheckout">
        <div class="row">
            <div class="col-lg-7 mb-3">
                <div class="card shadow-sm">
                    <div class="card-header">
                        Datos del cliente
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nombre_cliente" class="form-label">Nombre</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="nombre_cliente"
                                    name="nombre_cliente"
                                    value="{{ cliente_nombre or '' }}"
                                    readonly
                                >
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="apellido_cliente" class="form-label">Apellido</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="apellido_cliente"
                                    name="apellido_cliente"
                                    value="{{ cliente_apellido or '' }}"
                                    readonly
                                >
                            </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label for="metodo_pago" class="form-label">Método de pago</label>
                            <div class="d-flex gap-2">
                                <select
                                    class="form-select"
                                    id="metodo_pago"
                                    name="metodo_pago"
                                >
                                    {% if metodos_pago %}
                                        <option value="">Selecciona un método de pago...</option>
                                        {% for mp in metodos_pago %}
                                            <option
                                                value="{{ mp.ID_Metodo }}"
                                                data-tipo="{{ mp.Tipo }}"
                                            >
                                                {{ mp.Nombre }}
                                            </option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="">No tienes métodos de pago configurados</option>
                                    {% endif %}
                                </select>
                                <a
                                    href="{{ url_for('tus_metodos_pago') }}"
                                    class="btn btn-outline-primary"
                                    id="btnAgregarMetodoPago"
                                >
                                    Agregar
                                </a>
                            </div>
                        </div>

                        <div class="mb-3 d-none" id="boxTarjeta">
                            <label for="tarjeta_id" class="form-label">Tarjeta</label>
                            <select
                                class="form-select"
                                id="tarjeta_id"
                                name="tarjeta_id"
                            >
                                {% set tarjetas_ = tarjetas or [] %}
                                {% if tarjetas_ %}
                                    <option value="">Selecciona una tarjeta...</option>
                                    {% for t in tarjetas_ %}
                                        <option value="{{ t.id_pago }}">
                                            {{ t.label }}
                                        </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="">No tienes tarjetas guardadas</option>
                                {% endif %}
                            </select>
                        </div>

                        <div class="mb-3 d-none" id="boxMixto">
                            <label for="efectivo_monto" class="form-label">Monto en efectivo</label>
                            <input
                                type="number"
                                step="0.01"
                                min="0"
                                class="form-control"
                                id="efectivo_monto"
                                name="efectivo_monto"
                                placeholder="Ejemplo: 100.00"
                            >
                            <div id="efectivo_error" class="text-danger small mt-1 d-none"></div>
                        </div>

                        <div class="mb-3">
                            <label for="direccion_cliente" class="form-label">Dirección de entrega</label>
                            <div class="d-flex gap-2">
                                <select
                                    class="form-select"
                                    id="direccion_cliente"
                                    name="direccion_id"
                                >
                                    {% if direcciones %}
                                        <option value="">Selecciona una dirección...</option>
                                        {% for d in direcciones %}
                                            <option value="{{ d.id }}">{{ d.texto }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="">No tienes direcciones guardadas</option>
                                    {% endif %}
                                </select>
                                <a
                                    href="{{ url_for('tus_direcciones') }}"
                                    class="btn btn-outline-secondary"
                                    id="btnAgregarDireccion"
                                >
                                    Agregar
                                </a>
                            </div>
                            {% if not direcciones %}
                                <small class="text-muted">
                                    Debes agregar al menos una dirección antes de pagar.
                                </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5 mb-3">
                <div class="card shadow-sm mb-3">
                    <div class="card-header">
                        Resumen de la compra
                    </div>
                    <div class="card-body">
                        {% if items %}
                            <div class="summary-items mb-3">
                                {% for item in items %}
                                    <div class="summary-item-row">
                                        <div>
                                            <div class="summary-item-name">{{ item.nombre }}</div>
                                            <div class="summary-item-qty">
                                                {{ item.cantidad }} x
                                                Lps. {{ "%.2f"|format(item.precio_unit or 0) }}
                                            </div>
                                        </div>
                                        <div class="summary-item-subtotal">
                                            Lps. {{ "%.2f"|format(item.subtotal or 0) }}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Total a pagar:</span>
                                <span class="summary-total">
                                    Lps. {{ "%.2f"|format(total_general or 0) }}
                                </span>
                            </div>
                        {% else %}
                            <p>No tienes productos en el carrito.</p>
                        {% endif %}
                    </div>
                </div>

                <button
                    type="submit"
                    class="btn btn-secondary w-100"
                    id="btnPagar"
                    {% if not items or not direcciones %}disabled{% endif %}
                >
                    Pagar ahora
                </button>

                {% if not items %}
                    <small class="text-muted d-block mt-2">
                        Agrega productos al carrito antes de continuar.
                    </small>
                {% elif not direcciones %}
                    <small class="text-muted d-block mt-2">
                        Para habilitar el botón de pago necesitas al menos una dirección.
                    </small>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const selectMetodo = document.getElementById("metodo_pago");
    const boxTarjeta = document.getElementById("boxTarjeta");
    const boxMixto = document.getElementById("boxMixto");
    const selectDireccion = document.getElementById("direccion_cliente");
    const selectTarjeta = document.getElementById("tarjeta_id");
    const inputEfectivo = document.getElementById("efectivo_monto");
    const efectivoError = document.getElementById("efectivo_error");
    const btnPagar = document.getElementById("btnPagar");

    const tieneItems = {{ 'true' if items else 'false' }};
    const tieneDirecciones = {{ 'true' if direcciones else 'false' }};
    const totalPagar = parseFloat("{{ '%.2f'|format(total_general or 0) }}") || 0;

    function tipoSeleccionado() {
        if (!selectMetodo || selectMetodo.selectedIndex < 0) return "";
        const opt = selectMetodo.options[selectMetodo.selectedIndex];
        return (opt && opt.getAttribute("data-tipo")) ? opt.getAttribute("data-tipo") : "";
    }

    function setEfectivoError(msg) {
        if (!efectivoError) return;
        if (msg) {
            efectivoError.textContent = msg;
            efectivoError.classList.remove("d-none");
        } else {
            efectivoError.textContent = "";
            efectivoError.classList.add("d-none");
        }
    }

    function validarEfectivoMixto(mostrarRequerido) {
        if (!inputEfectivo) return true;

        const tipo = tipoSeleccionado();
        if (tipo !== "3") {
            inputEfectivo.classList.remove("is-invalid");
            setEfectivoError("");
            return true;
        }

        const min = Math.round((totalPagar * 0.10) * 100) / 100;
        const max = Math.round((totalPagar * 0.50) * 100) / 100;

        inputEfectivo.min = String(min);
        inputEfectivo.max = String(max);

        const raw = (inputEfectivo.value || "").trim();
        if (!raw) {
            if (mostrarRequerido) {
                inputEfectivo.classList.add("is-invalid");
                setEfectivoError(`El efectivo debe estar entre Lps. ${min.toFixed(2)} (10%) y Lps. ${max.toFixed(2)} (50%).`);
                return false;
            }
            inputEfectivo.classList.remove("is-invalid");
            setEfectivoError("");
            return false;
        }

        const val = parseFloat(raw);
        if (!(val > 0)) {
            inputEfectivo.classList.add("is-invalid");
            setEfectivoError(`El efectivo debe estar entre Lps. ${min.toFixed(2)} (10%) y Lps. ${max.toFixed(2)} (50%).`);
            return false;
        }

        const eps = 0.005;

        if (val < (min - eps)) {
            inputEfectivo.classList.add("is-invalid");
            setEfectivoError(`El efectivo no puede ser menor al 10%: mínimo Lps. ${min.toFixed(2)}.`);
            return false;
        }

        if (val > (max + eps)) {
            inputEfectivo.classList.add("is-invalid");
            setEfectivoError(`El efectivo no puede ser mayor al 50%: máximo Lps. ${max.toFixed(2)}.`);
            return false;
        }

        inputEfectivo.classList.remove("is-invalid");
        setEfectivoError("");
        return true;
    }

    function actualizarUI() {
        const tipo = tipoSeleccionado();

        boxTarjeta.classList.add("d-none");
        boxMixto.classList.add("d-none");

        if (tipo === "2") {
            boxTarjeta.classList.remove("d-none");
        } else if (tipo === "3") {
            boxTarjeta.classList.remove("d-none");
            boxMixto.classList.remove("d-none");
        }

        validarEfectivoMixto(true);
    }

    function actualizarEstadoBoton() {
        if (!btnPagar) return;

        let habilitar = true;

        if (!tieneItems || !tieneDirecciones) habilitar = false;

        const metodoSeleccionado = selectMetodo && selectMetodo.value;
        const direccionSeleccionada = selectDireccion && selectDireccion.value;

        if (!metodoSeleccionado) habilitar = false;
        if (!direccionSeleccionada) habilitar = false;

        const tipo = tipoSeleccionado();

        if (tipo === "2") {
            const tarjetaSeleccionada = selectTarjeta && selectTarjeta.value;
            if (!tarjetaSeleccionada) habilitar = false;
        }

        if (tipo === "3") {
            const tarjetaSeleccionada = selectTarjeta && selectTarjeta.value;
            const efectivoOk = validarEfectivoMixto(false);

            if (!tarjetaSeleccionada) habilitar = false;
            if (!efectivoOk) habilitar = false;
        }

        btnPagar.disabled = !habilitar;
        btnPagar.classList.toggle("btn-success", habilitar);
        btnPagar.classList.toggle("btn-secondary", !habilitar);
    }

    if (selectMetodo) {
        selectMetodo.addEventListener("change", function () {
            actualizarUI();
            actualizarEstadoBoton();
        });
    }

    if (selectDireccion) {
        selectDireccion.addEventListener("change", actualizarEstadoBoton);
    }

    if (selectTarjeta) {
        selectTarjeta.addEventListener("change", actualizarEstadoBoton);
    }

    if (inputEfectivo) {
        inputEfectivo.addEventListener("input", function () {
            validarEfectivoMixto(false);
            actualizarEstadoBoton();
        });

        inputEfectivo.addEventListener("blur", function () {
            validarEfectivoMixto(true);
            actualizarEstadoBoton();
        });
    }

    actualizarUI();
    actualizarEstadoBoton();
});
</script>

</body>
</html>
