<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Recetas | Alitas El Comel√≥n</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #fafafa;
            margin: 0;
        }

        header {
            background-color: #b80000;
            color: white;
            text-align: center;
            padding: 20px;
        }
        .btn-action {
            margin-top: 8px;
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            border:none;
    }   
        .btn-action1{
            margin-top: 8px;
            display: inline-block;
            background-color: #ff0000;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            outline:none;
            border:none;
        }

        nav {
            display: flex;
            justify-content: center;
            background-color: #e60000;
            padding: 10px 0;
            gap: 30px;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: 0.3s;
        }

        nav a:hover { color: #ffcc00; }

        .contenedor { width: 90%; margin: 30px auto; }

        .categoria h2 {
            color: #b80000;
            border-bottom: 2px solid #b80000;
            padding-bottom: 10px;
        }

        .items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .boton-estado {
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .activo { background-color: #28a745; color: white; }
        .inactivo { background-color: #dc3545; color: white; }

        .boton-ver {
            margin-top: 8px;
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
        }

        footer {
            background-color: #b80000;
            text-align: center;
            padding: 20px;
            color: white;
            margin-top: 40px;
        }
    </style>
</head>
<body>

<header>
    <h1>üë®‚Äçüç≥ Panel de recetas</h1>
<div style="display:flex;gap:10px;justify-content:flex-end;margin:10px 0;"><a class="btn btn-danger" href="{{ url_for('reports.exportar', reporte='receta', formato='pdf') }}">Exportar PDF</a><a class="btn btn-success" href="{{ url_for('reports.exportar', reporte='receta', formato='excel') }}">Exportar Excel</a></div>

</header>

<nav>
    <a href="{{ url_for('crear_receta') }}">‚ûï Crear Nueva Receta</a>
    <a href="{{ url_for('login_jefe.panel_jefe') }}">‚¨Ö Volver al panel principal</a>
</nav>

<div class="contenedor">
    {% for categoria, items in categorias.items() %}
    <div class="categoria" id="cat-{{ loop.index }}">

        <h2 class="d-flex justify-content-between align-items-center">
            <span>{{ categoria }}</span>

            <button class="btn-action1" type="button"
                    onclick='eliminarCategoria({{ categoria|tojson }})'>
                Eliminar categor√≠a
            </button>
        </h2>

        <div class="items">
            {% for item in items %}
            <div class="item">

                <div class="nombre fw-bold">{{ item.nombre }}</div>
                <div class="descripcion text-secondary">{{ item.descripcion }}</div>
                <div class="precio text-danger fw-bold">{{ item.precio }}</div>

                <button
                    class="boton-estado {{ 'activo' if item.activo == 1 else 'inactivo' }}"
                    onclick="toggleEstado({{ item.id }}, this)">
                    {{ 'Activo' if item.activo == 1 else 'Inactivo' }}
                </button>

                <a href="{{ url_for('jefe_ver_receta', id_receta=item.id) }}" class="boton-ver">
                    Ver ingredientes
                </a>

                <button class="btn-action" type="button"
                        onclick="window.location.href='{{ url_for('editar_receta', id_receta=item.id) }}'">
                    Editar
                </button>

                <button class="btn-action1" type="button"
                        onclick="confirmarEliminacion({{ item.id }})">
                    Eliminar
                </button>

            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<footer>
    ¬© 2025 Alitas El Comel√≥n - Panel del Jefe de Cocina
</footer>

<script>
function leerJsonSeguro(texto) {
    try { return JSON.parse(texto); } catch (e) { return null; }
}

function fetchJsonConError(url, opciones) {
    return fetch(url, opciones).then(async (res) => {
        const texto = await res.text();
        const data = leerJsonSeguro(texto) || {};
        if (!res.ok) {
            const msg = data.message || "No se pudo completar la operaci√≥n.";
            throw new Error(msg);
        }
        return data;
    });
}

function toggleEstado(idReceta, boton) {
    fetch("{{ url_for('toggle_receta_estado') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id_receta: idReceta })
    })
    .then(res => res.json())
    .then(data => {
        if (data.nuevo_estado === 1) {
            boton.classList.remove("inactivo");
            boton.classList.add("activo");
            boton.textContent = "Activo";
        } else {
            boton.classList.remove("activo");
            boton.classList.add("inactivo");
            boton.textContent = "Inactivo";
        }
    })
    .catch(() => {});
}

function confirmarEliminacion(idReceta) {
    if (!confirm("¬øEliminar receta?")) return;

    const base = "{{ url_for('eliminar_receta', id_receta=0) }}";
    const url = base.replace("/0", "/" + idReceta);

    fetchJsonConError(url, { method: "DELETE" })
        .then(() => location.reload())
        .catch((err) => alert(err.message || "No se pudo eliminar la receta."));
}

function eliminarCategoria(nombreCategoria) {
    if (!confirm("¬øEliminar categor√≠a?")) return;

    const base = "{{ url_for('eliminar_categoria', nombre_categoria='__CAT__') }}";
    const url = base.replace("__CAT__", encodeURIComponent(nombreCategoria));

    fetchJsonConError(url, { method: "DELETE" })
        .then((data) => {
            alert((data && data.message) ? data.message : "Categor√≠a eliminada correctamente.");
            location.reload();
        })
        .catch((err) => {
            alert(err.message || "No se pudo eliminar la categor√≠a.");
        });
}
</script>

</body>
</html>
